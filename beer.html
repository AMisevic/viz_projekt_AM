<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Beer Consumption Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    svg { width: 100vw; height: 95vh; display: block; }
    #tooltip {
      position: absolute;
      background: white;
      border: 1px solid #999;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
    }
    #controls {
      margin: 10px;
      font-size: 14px;
    }
    .country {
      stroke: #333;
      stroke-width: 0.5;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="yearSlider">Year: <span id="yearLabel"></span></label>
    <input type="range" id="yearSlider" min="1960" max="2019" value="2019" step="1" />
    <label for="regionSelect">Region:</label>
    <select id="regionSelect">
      <option value="World">World</option>
      <option value="Africa">Africa</option>
      <option value="Asia">Asia</option>
      <option value="Europe">Europe</option>
      <option value="North America">North America</option>
      <option value="South America">South America</option>
      <option value="Oceania">Oceania</option>
    </select>
  </div>
  <svg></svg>
  <div id="tooltip"></div>

  <script>
    const svg = d3.select("svg");
    const width = window.innerWidth;
    const height = window.innerHeight;
    const tooltip = d3.select("#tooltip");

    const projection = d3.geoMercator()
      .scale(160)
      .translate([width / 2, height / 1.5]);

    const path = d3.geoPath().projection(projection);

    const regionZoom = {
      "World": { scale: 160, center: [0, 20] },
      "Africa": { scale: 400, center: [20, 0] },
      "Asia": { scale: 300, center: [100, 30] },
      "Europe": { scale: 500, center: [20, 50] },
      "North America": { scale: 300, center: [-100, 40] },
      "South America": { scale: 350, center: [-60, -15] },
      "Oceania": { scale: 400, center: [140, -25] }  
    };

    const colorScale = d3.scaleLinear()
      .domain([0, 2, 4, 6, 8, 10])
      .range([
        "#f9f871", // Lager
        "#f6e27f", // Pilsner
        "#f5b041", // Pale Ale
        "#d35400", // IPA
        "#a04000", // Amber
        "#3e2723", // Stout 
      ]);

    let beerDataByYear = {};

    const yearSlider = d3.select("#yearSlider");
    const yearLabel = d3.select("#yearLabel");

    const nameMap = {
      "United States of America": "United States",
      "USA": "United States", 
      "England": "United Kingdom", 
    }

    Promise.all([
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
      d3.csv("beer-consumption-per-person.csv")
    ]).then(([geoData, beerData]) => {
      //console.log(beerData.slice(0, 5));
      
      beerData.forEach(d => {
        const country = d.Entity;
        const year = +d.Year;
        const value = +d.BeerValue;

        if (!beerDataByYear[year]) beerDataByYear[year] = {};
        beerDataByYear[year][country] = value;
      });

      //console.log("beerDataByYear example:", beerDataByYear[2001]); 

      const countries = geoData.features;

      const g = svg.append("g");

      const paths = g.selectAll("path")
        .data(countries)
        .join("path")
        .attr("class", "country")
        .attr("d", path)
        .on("mouseover", function (event, d) {
          const rawName = d.properties.name;
          const name = nameMap[rawName] ||rawName;
          const year = yearSlider.property("value");
          const data = beerDataByYear[year]?.[name];

          //console.log("Hovering:", rawName, "->", name, "->", data);

          tooltip
            .style("opacity", 1)
            .html(`<strong>${name}</strong><br/>Beer: ${data ? data : "N/A"} L`);
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 20) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("opacity", 0);
        });

      updateMap(yearSlider.property("value"))

      function updateMap(year) {
        yearLabel.text(year);
        paths.transition().duration(500)
          .attr("fill", d => {
            const name = nameMap[d.properties.name] || d.properties.name;
            const val = beerDataByYear[year]?.[name];
            return val ? colorScale(val) : "#ccc";
          });
      }

      yearSlider.on("input", function () {
        updateMap(this.value);
      });

      d3.select("#regionSelect").on("change", function () {
        const region = this.value;
        const zoom = regionZoom[region];

        const oldScale = projection.scale();
        const oldCenter = projection.center();

        const newScale = zoom.scale;
        const newCenter = zoom.center;

        const interpolateScale = d3.interpolateNumber(oldScale, newScale);
        const interpolateCenter = d3.interpolateArray(oldCenter, newCenter);

        d3.transition()
          .duration(1000)
          .tween("zoom", () => {
            return function (t) {
              projection
                .scale(interpolateScale(t))
                .center(interpolateCenter(t))
                .translate([width / 2, height / 2]);

              const newPath = d3.geoPath().projection(projection);
              g.selectAll("path").attr("d", newPath);
            };
          });

        updateMap(yearSlider.property("value"));
      });
    });
  </script>
</body>
</html>